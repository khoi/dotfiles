#!/bin/sh
# This script runs when packages.yaml changes
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# {{ include ".chezmoidata/packages.yaml" | sha256sum }}

set -eufo pipefail

echo "ðŸ“¦ Installing declarative packages from packages.yaml"

# Keep-alive: update existing `sudo` time stamp until the script finished
while true; do
	sudo -n true
	sleep 60
	kill -0 "$$" || exit
done 2>/dev/null &

{{ if eq .chezmoi.os "darwin" -}}
# Ensure Homebrew is in PATH
{{ output "/opt/homebrew/bin/brew" "shellenv" | trim }}

brew bundle --file=/dev/stdin <<EOF || :
{{ range (index .packages.darwin "taps") -}}
tap "{{ . }}"
{{ end -}}
{{ range (index .packages.darwin "casks") -}}
cask "{{ . }}"
{{ end -}}
{{ range (index .packages.darwin "brews") -}}
brew "{{ . }}"
{{ end -}}
EOF

# Extra homebrew setup
if [ -d "/opt/homebrew/opt/fzf" ]; then
    /opt/homebrew/opt/fzf/install --all --no-bash --no-zsh --no-fish 2>/dev/null || true
fi
{{ end -}}

echo "âœ… Package installation complete"