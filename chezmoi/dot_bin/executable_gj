#!/usr/bin/env bash

set -Eeuo pipefail

script_name=$(basename "$0")
version="0.1.0"

usage() {
  cat <<EOF
Usage:
  $script_name get [git clone flags...] <repo>

Config:
  gj.root   Existing directory where repositories are stored.

Examples:
  $script_name get org/repo
  $script_name get https://github.com/org/repo
  $script_name get --depth 1 git@github.com:org/repo.git
  git config --global gj.root ~/Developer/code
EOF
}

die() {
  printf '%s\n' "$*" >&2
  exit 1
}

require_git() {
  command -v git >/dev/null 2>&1 || die "git is required on PATH"
}

is_shorthand() {
  local input=$1
  [[ "$input" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]
}

expand_shorthand() {
  printf 'https://github.com/%s\n' "$1"
}

parse_repo() {
  local input=$1
  local host path no_scheme

  if [[ "$input" =~ ^[a-zA-Z][a-zA-Z0-9+.-]*:// ]]; then
    no_scheme="${input#*://}"
    host="${no_scheme%%/*}"
    path="${no_scheme#*/}"
  elif [[ "$input" == *@*:* ]]; then
    host="${input#*@}"
    host="${host%%:*}"
    path="${input#*:}"
  else
    host="${input%%/*}"
    path="${input#*/}"
  fi

  host="${host#*@}"
  host="${host%%:*}"
  path="${path#/}"
  path="${path%.git}"

  if [[ -z "$host" || -z "$path" || "$path" == "$host" ]]; then
    return 1
  fi

  printf '%s/%s\n' "$host" "$path"
}

run_get() {
  local repo dest rel
  local flags=()

  if [[ $# -lt 1 ]]; then
    usage
    exit 2
  fi

  root=$(git config --global --get gj.root || true)
  if [[ -z "$root" ]]; then
    die "gj.root is not set in git config"
  fi

  root="${root/#\~/$HOME}"
  if [[ ! -d "$root" ]]; then
    die "gj.root does not exist: $root"
  fi

  if [[ $# -eq 1 ]]; then
    repo="$1"
  else
    repo="${@: -1}"
    flags=("${@:1:$#-1}")
  fi

  if is_shorthand "$repo"; then
    repo=$(expand_shorthand "$repo")
  fi

  if ! rel=$(parse_repo "$repo"); then
    die "Could not parse repo: $repo"
  fi

  dest="$root/$rel"

  if [[ -e "$dest" ]]; then
    if [[ -d "$dest/.git" ]]; then
      git -C "$dest" remote update --prune
      printf '%s\n' "$dest"
      return 0
    fi
    die "Destination exists and is not a git repo: $dest"
  fi

  mkdir -p "$(dirname "$dest")"
  git clone ${flags[@]+"${flags[@]}"} "$repo" "$dest"
  printf '%s\n' "$dest"
}

main() {
  if [[ $# -lt 1 ]]; then
    usage
    exit 2
  fi

  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    --version)
      printf '%s\n' "$version"
      exit 0
      ;;
    get)
      shift
      require_git
      run_get "$@"
      ;;
    *)
      die "Unknown command: $1"
      ;;
  esac
}

main "$@"
