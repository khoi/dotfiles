#!/usr/bin/env bash

set -uo pipefail

THEMES_DIR="$HOME/.config/themes"
NVIM_THEME_FILE="$HOME/.config/nvim/lua/plugins/theme.lua"
GHOSTTY_CONFIG="$HOME/.config/ghostty/config"
ZED_SETTINGS="$HOME/.config/zed/settings.json"
BTOP_THEME_DIR="$HOME/.config/btop/themes"
BTOP_CONF="$HOME/.config/btop/btop.conf"
ZELLIJ_THEME_DIR="$HOME/.config/zellij/themes"
ZELLIJ_CONFIG="$HOME/.config/zellij/config.kdl"
LAZYGIT_CONFIG="$HOME/.config/lazygit/config.yml"
GHOSTTY_MARK_BEGIN="# switch-theme ghostty begin"
GHOSTTY_MARK_END="# switch-theme ghostty end"

slugify() {
  local s="$1"
  s=$(echo "$s" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g; s/--*/-/g; s/^-//; s/-$//')
  [[ -z "$s" ]] && s="default"
  echo "$s"
}

friendly() {
  echo "$1" | tr '-' ' ' | awk '{for(i=1;i<=NF;i++){ $i=toupper(substr($i,1,1)) substr($i,2)}; print}'
}

list_themes() {
  if [[ -d "$THEMES_DIR" ]]; then
    for d in "$THEMES_DIR"/*; do
      [[ -d "$d" ]] && basename "$d"
    done | sort
  fi
}

usage() {
  ensure_themes_dir
  local opts
  opts=$(list_themes | paste -sd, -)
  echo "Usage: switch-theme <theme-name>"
  echo "Available themes: ${opts:-none found}"
}

ensure_themes_dir() {
  if [[ ! -d "$THEMES_DIR" ]]; then
    echo "Themes dir missing: $THEMES_DIR" >&2
    exit 1
  fi
}

detect_background() {
  local slug="$1" dir="$2"
  if [[ -f "$dir/light.mode" ]] || [[ "$slug" =~ (light|latte|dawn) ]]; then
    echo "light"
  else
    echo "dark"
  fi
}

parse_colorscheme() {
  local dir="$1"
  if [[ -f "$dir/neovim.lua" ]]; then
    sed -n 's/.*colorscheme[^"]*"\([^"]*\)".*/\1/p' "$dir/neovim.lua" | head -n1
  fi
}

parse_ghostty_theme() {
  local dir="$1"
  [[ -f "$dir/ghostty.conf" ]] || return 0
  sed -n 's/^[[:space:]]*theme[[:space:]]*=[[:space:]]*//p' "$dir/ghostty.conf" | head -n1
}

write_nvim_theme() {
  local dir="$1" slug="$2" colorscheme="$3" background="$4"
  mkdir -p "$(dirname "$NVIM_THEME_FILE")"
  {
    echo "-- Generated by switch-theme from themes/$slug"
    echo "vim.g.switch_theme = { name = \"$slug\", colorscheme = \"$colorscheme\", background = \"$background\" }"
    echo
    if [[ -f "$dir/neovim.lua" ]]; then
      cat "$dir/neovim.lua"
    else
      cat <<EOF
return {
  { "LazyVim/LazyVim", opts = { colorscheme = "$colorscheme" } },
}
EOF
    fi
  } >"$NVIM_THEME_FILE"
}

apply_ghostty() {
  local dir="$1" slug="$2" theme_name="$3"
  if [[ ! -f "$GHOSTTY_CONFIG" ]]; then
    echo "[ghostty] warning: ghostty config missing at $GHOSTTY_CONFIG" >&2
    return 0
  fi

  local tmp
  tmp=$(mktemp)
  awk -v begin="$GHOSTTY_MARK_BEGIN" -v end="$GHOSTTY_MARK_END" '
    $0==begin {inblk=1; next}
    $0==end {inblk=0; next}
    !inblk {print}
  ' "$GHOSTTY_CONFIG" >"$tmp"

  if [[ -n "$theme_name" ]]; then
    if grep -q '^[[:space:]]*theme[[:space:]]*=' "$tmp"; then
      perl -pi -e 's/^\s*theme\s*=.*/theme = '"$theme_name"'/g' "$tmp"
    else
      echo "theme = $theme_name" >>"$tmp"
    fi
    mv "$tmp" "$GHOSTTY_CONFIG"
    chmod 644 "$GHOSTTY_CONFIG" 2>/dev/null || true
    echo "[ghostty] theme=$theme_name"
    return 0
  fi

  local palette_file="$dir/ghostty.conf"
  if [[ ! -f "$palette_file" ]]; then
    echo "[ghostty] warning: ghostty.conf missing in $dir" >&2
    rm -f "$tmp"
    return 0
  fi

  {
    grep -v '^[[:space:]]*theme[[:space:]]*=' "$tmp"
    echo "$GHOSTTY_MARK_BEGIN"
    echo "# theme: $slug"
    cat "$palette_file"
    echo "$GHOSTTY_MARK_END"
  } >"$GHOSTTY_CONFIG"
  rm -f "$tmp"
  chmod 644 "$GHOSTTY_CONFIG" 2>/dev/null || true
  echo "[ghostty] inline palette applied"
}

apply_zed() {
  local theme_name="$1"
  if [[ -z "$theme_name" ]]; then
    echo "[zed] warning: theme missing" >&2
    return 0
  fi
  if [[ ! -f "$ZED_SETTINGS" ]]; then
    echo "[zed] warning: settings not found at $ZED_SETTINGS" >&2
    return 0
  fi
  perl -0777 -i -pe '
    my $t = "'"$theme_name"'";
    if (s/"theme"\s*:\s*"[^"]*"/"theme\": \"$t\"/s) {
    } else {
      s/\{/\{\n  "theme": "$t",/;
    }
  ' "$ZED_SETTINGS"
  echo "[zed] theme=$theme_name"
}

declare -A PALETTE

load_palette() {
  local file="$1"
  if [[ ! -f "$file" ]]; then
    return 1
  fi
  PALETTE=()
  while IFS= read -r line; do
    if [[ $line =~ theme\[([^\]]+)\][[:space:]]*=[[:space:]]*\"?(#[A-Fa-f0-9]{6})\"? ]]; then
      local key="${BASH_REMATCH[1]}"
      local val="${BASH_REMATCH[2]}"
      [[ $val != \#* ]] && val="#$val"
      PALETTE["$key"]="$val"
    fi
  done <"$file"
  return 0
}

apply_btop() {
  local dir="$1" slug="$2"
  local theme_file="$dir/btop.theme"
  if [[ ! -f "$theme_file" ]]; then
    echo "[btop] warning: theme file missing at $theme_file" >&2
    return 0
  fi
  mkdir -p "$BTOP_THEME_DIR"
  cp "$theme_file" "$BTOP_THEME_DIR/$slug.theme"
  if [[ ! -f "$BTOP_CONF" ]]; then
    echo "[btop] warning: config missing at $BTOP_CONF" >&2
    return 0
  fi
  if grep -q '^color_theme' "$BTOP_CONF"; then
    perl -pi -e 's/^color_theme\s*=.*$/color_theme = "'"$slug"'"/' "$BTOP_CONF"
  else
    echo "color_theme = \"$slug\"" >>"$BTOP_CONF"
  fi
  load_palette "$theme_file"
  echo "[btop] theme=$slug (palette entries=${#PALETTE[@]})"
}

apply_zellij() {
  local slug="$1"
  if [[ ${#PALETTE[@]} -eq 0 ]]; then
    echo "[zellij] warning: palette missing; zellij theme not generated" >&2
    return 0
  fi
  mkdir -p "$ZELLIJ_THEME_DIR"
  local file="$ZELLIJ_THEME_DIR/$slug.kdl"
  if [[ ! -f "$file" ]]; then
    local fg="${PALETTE[main_fg]:-#dcd7ba}"
    local bg="${PALETTE[main_bg]:-#1f1f28}"
    local red="${PALETTE[temp_end]:-${PALETTE[hi_fg]:-#f7768e}}"
    local green="${PALETTE[cpu_start]:-${PALETTE[temp_start]:-#98bb6c}}"
    local yellow="${PALETTE[temp_mid]:-${PALETTE[cpu_mid]:-#c0a36e}}"
    local blue="${PALETTE[process_mid]:-${PALETTE[download_start]:-#7fb4ca}}"
    local magenta="${PALETTE[available_mid]:-${PALETTE[selected_fg]:-#957fb8}}"
    local cyan="${PALETTE[process_start]:-${PALETTE[cached_start]:-#6a9589}}"
    local white="${PALETTE[selected_fg]:-$fg}"
    local orange="${PALETTE[available_start]:-${PALETTE[hi_fg]:-$yellow}}"
    cat >"$file" <<EOF
// ${slug^} theme for Zellij
themes {
    $slug {
        fg "$fg"
        bg "$bg"
        black "$bg"
        red "$red"
        green "$green"
        yellow "$yellow"
        blue "$blue"
        magenta "$magenta"
        cyan "$cyan"
        white "$white"
        orange "$orange"
    }
}
EOF
  fi
  if [[ -f "$ZELLIJ_CONFIG" ]]; then
    perl -pi -e 's/^theme\s+".*"/theme "'"$slug"'"/' "$ZELLIJ_CONFIG"
    echo "[zellij] theme=$slug"
    return 0
  else
    echo "[zellij] warning: config missing at $ZELLIJ_CONFIG" >&2
    return 0
  fi
}

apply_lazygit() {
  local slug="$1"
  if [[ ! -f "$LAZYGIT_CONFIG" ]]; then
    echo "[lazygit] warning: config missing at $LAZYGIT_CONFIG" >&2
    return 0
  fi
  if [[ ${#PALETTE[@]} -eq 0 ]]; then
    echo "[lazygit] warning: palette missing; cannot derive theme" >&2
    return 0
  fi

  local friendly_name
  friendly_name=$(friendly "$slug")
  local active="${PALETTE[cpu_mid]:-${PALETTE[hi_fg]:-${PALETTE[proc_misc]:-#7E9CD8}}}"
  local inactive="${PALETTE[div_line]:-${PALETTE[inactive_fg]:-${PALETTE[selected_bg]:-#54546D}}}"
  local options="${PALETTE[proc_misc]:-${PALETTE[selected_fg]:-${PALETTE[main_fg]:-#7FB4CA}}}"
  local selected_bg="${PALETTE[selected_bg]:-${PALETTE[process_mid]:-${PALETTE[main_bg]:-#363646}}}"
  local cherry_fg="${PALETTE[selected_fg]:-${PALETTE[available_mid]:-${PALETTE[main_fg]:-#957FB8}}}"
  local default_fg="${PALETTE[main_fg]:-#DCD7BA}"
  local unstaged="${PALETTE[temp_end]:-${PALETTE[hi_fg]:-${PALETTE[available_end]:-#E82424}}}"
  local searching="${PALETTE[temp_mid]:-${PALETTE[cpu_mid]:-$active}}"

  local block
  block=$(cat <<EOF
  # $friendly_name theme
  theme:
    activeBorderColor:
      - "$active"
      - bold
    inactiveBorderColor:
      - "$inactive"
    optionsTextColor:
      - "$options"
    selectedLineBgColor:
      - "$selected_bg"
    cherryPickedCommitBgColor:
      - "$selected_bg"
    cherryPickedCommitFgColor:
      - "$cherry_fg"
    unstagedChangesColor:
      - "$unstaged"
    defaultFgColor:
      - "$default_fg"
    searchingActiveBorderColor:
      - "$searching"
EOF
)

  BLOCK="$block" perl -0777 -i -pe '
    my $block = $ENV{BLOCK};
    if (s/^  # .* theme\n  theme:\n(?:    .*\n?)*\n?/$block\n/m) {
    } else {
      $_ =~ s/\s+\z/\n/;
      $_ .= "\n$block\n";
    }
  ' "$LAZYGIT_CONFIG"
  echo "[lazygit] theme=$slug"
}

reload_running_apps() {
  echo "[reload] kitty"
  pkill -SIGUSR1 kitty 2>/dev/null || true
  echo "[reload] ghostty"
  osascript -e 'tell application "System Events" to tell process "ghostty" to keystroke "," using {command down, shift down}' 2>/dev/null || true
  echo "[reload] btop"
  pkill -SIGUSR2 btop 2>/dev/null || true
  echo "[reload] zellij"
  zellij action reload-config 2>/dev/null || true
}

main() {
  if [[ "${1:-}" == "-h" || "${1:-}" == "--help" || "${1:-}" == "--list" ]]; then
    usage
    exit 0
  fi

  ensure_themes_dir

  local slug
  if [[ $# -eq 0 ]]; then
    if command -v fzf &>/dev/null; then
      slug=$(list_themes | fzf --prompt="theme> ")
      [[ -z "$slug" ]] && exit 0
    else
      usage
      exit 0
    fi
  else
    slug=$(slugify "$1")
  fi
  local theme_dir="$THEMES_DIR/$slug"
  if [[ ! -d "$theme_dir" ]]; then
    echo "Theme '$slug' not found in $THEMES_DIR" >&2
    usage
    exit 1
  fi

  local background
  background=$(detect_background "$slug" "$theme_dir")
  local colorscheme
  colorscheme=$(parse_colorscheme "$theme_dir") || true
  [[ -z "$colorscheme" ]] && colorscheme="$slug"
  local ghostty_theme
  ghostty_theme=$(parse_ghostty_theme "$theme_dir") || true

  echo "[theme] applying $slug"

  write_nvim_theme "$theme_dir" "$slug" "$colorscheme" "$background" || exit 1
  echo "[nvim] colorscheme=$colorscheme, bg=$background"

  apply_ghostty "$theme_dir" "$slug" "$ghostty_theme"
  local zed_name="${ghostty_theme:-$(friendly "$slug")}"
  apply_zed "$zed_name"
  apply_btop "$theme_dir" "$slug"
  apply_zellij "$slug"
  apply_lazygit "$slug"

  reload_running_apps
  echo "Switched to $slug (background=$background, nvim=$colorscheme)"
}

main "$@"
